<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@knt5"><meta name="twitter:creator" content="@knt5"><meta name="twitter:title" content="Kenta Motomura"><meta name="twitter:description" content="Hakoniwa: JAXA ALOS DSM 3D visualizer"><meta name="twitter:image:src" content="https://knt5.github.io/assets/img/twitter/summary-large-image/hakoniwa.jpg"><title>Hakoniwa</title><link rel="icon" type="image/png" href="assets/img/favicon.png"><link rel="apple-touch-icon" type="image/png" href="assets/img/favicon.png"><style>html,body,div,span,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,abbr,address,cite,code,del,dfn,em,img,ins,kbd,q,samp,small,strong,sub,sup,var,b,i,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,figcaption,figure,footer,header,hgroup,menu,nav,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}ol,ul{padding-left:20px}article,aside,details,figcaption,figure,footer,header,hgroup,menu,nav,section{display:block}nav ul{list-style:none}blockquote,q{quotes:none}blockquote::before,blockquote::after,q::before,q::after{content:none}a{margin:0;padding:0;font-size:100%;vertical-align:baseline;background:transparent}ins{background-color:#ff9;color:#000;text-decoration:none}mark{background-color:#ff9;color:#000;font-style:italic;font-weight:bold}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}hr{display:block;height:1px;border:0;border-top:1px solid #ccc;margin:1em 0;padding:0}input,select{vertical-align:middle}*,*::before,*::after{box-sizing:border-box}body{background:#000;color:#fff;font-size:18px;line-height:1.4;-webkit-text-size-adjust:100%}body,input,select,textarea,th,td{font-family:"Myriad Pro", "Lucida Grande", "GillSans", "Hiragino Kaku Gothic Pro", "Meiryo", "sans-serif"}a{color:#39f}a:link,a:visited,a:active{text-decoration:none}a:hover{text-decoration:underline}.clearfix::after{content:'';display:block;clear:both}.hidden{display:none}.main{position:relative;background:#000}.stage{position:relative;background-image:linear-gradient(to top, #434343, #000)}.header{position:absolute;top:0;left:0;padding:10px 15px;z-index:9000}.header h1{font-size:38px;font-weight:normal}.header p{font-size:12px}.message{margin-top:4px;font-size:14px}.error{margin-top:4px;font-size:14px;color:#f00}.dat-gui{position:absolute;bottom:0;left:0;z-index:9000}.map{position:absolute;bottom:0;right:0;width:300px;height:200px;z-index:9000}@media (max-width: 414px){.map{width:100%;height:120px}.github-ribbon img{width:74px;height:74px}.header h1{font-size:24px}}</style></head><body><canvas id="dsm-canvas" class="hidden"></canvas><canvas id="mask-canvas" class="hidden"></canvas><canvas id="work-canvas" class="hidden"></canvas><canvas id="work-mask-canvas" class="hidden"></canvas><div id="main" class="main"><div id="stage" class="stage"></div><header class="header"><h1>Hakoniwa</h1><p>JAXA ALOS DSM 3D visualizer Â© <a href="https://knt5.github.io/" target="_blank">knt5</a></p><div id="message" class="message"></div><div id="error" class="error"></div></header><div id="dat-gui" class="dat-gui"></div><div id="map" class="map"></div></div><div class="github-ribbon"><a href="https://github.com/knt5/hakoniwa"><img style="position: absolute; top: 0; right: 0; border: 0" src="https://camo.githubusercontent.com/52760788cde945287fbb584134c4cbc2bc36f904/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f77686974655f6666666666662e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png"></a></div><script src="assets/js/lib/jquery.min.js?v=3.0.0-beta1"></script><script src="assets/js/lib/three.min.js?v=r76"></script><script src="assets/js/lib/TrackballControls.js"></script><script src="assets/js/lib/dat.gui.min.js?v=0.5.1"></script><script>function initMap(){var t=config.dsm,e=config.work;map=new google.maps.Map($map.get(0),{center:{lat:e.north,lng:e.west},zoom:12});var a={north:t.north,south:t.south,east:t.east,west:t.west},o=new google.maps.GroundOverlay(t.path,a);o.setOpacity(.8),o.setMap(map),hakoniwa.init()}var config={dsm:{path:"assets/dsm/N035E139.tokyo.png",maskPath:"assets/dsm/N035E139.tokyo.mask.png",north:35.76,east:139.81,south:35.61,west:139.68,pixelSize:.000277777778,image:null,maskImage:null},work:{width:50,height:50,north:35.633678619189524,west:139.72721500523392},cube:{size:3},gui:{autoPilotEnabled:!0,autoPilotSpeed:1,elevationScale:4}},$window=$(window),$stage=$("#stage"),$dsmCanvas=$("#dsm-canvas"),$maskCanvas=$("#mask-canvas"),$workCanvas=$("#work-canvas"),$workMaskCanvas=$("#work-mask-canvas"),$datGui=$("#dat-gui"),$map=$("#map"),$message=$("#message"),$error=$("#error"),map,camera,renderer,dsmContext=$dsmCanvas.get(0).getContext("2d"),maskContext=$maskCanvas.get(0).getContext("2d"),workContext=$workCanvas.get(0).getContext("2d"),workMaskContext=$workMaskCanvas.get(0).getContext("2d");$(document).ready(function(){function t(){$stage.height($window.height()),camera&&renderer&&(camera.aspect=$stage.width()/$stage.height(),camera.updateProjectionMatrix(),renderer.setSize($stage.width(),$stage.height()))}$window.on("resize",t),t(),$workCanvas.width(config.work.width),$workCanvas.height(config.work.height),$workCanvas.prop("width",config.work.width),$workCanvas.prop("height",config.work.height),$workMaskCanvas.width(config.work.width),$workMaskCanvas.height(config.work.height),$workMaskCanvas.prop("width",config.work.width),$workMaskCanvas.prop("height",config.work.height);var e=new Image;e.src=config.dsm.path,e.onload=function(){var t=e.width,a=e.height;$dsmCanvas.width(t),$dsmCanvas.height(a),$dsmCanvas.prop("width",t),$dsmCanvas.prop("height",a),dsmContext.drawImage(e,0,0),config.dsm.image=e,hakoniwa.init()};var a=new Image;a.src=config.dsm.maskPath,a.onload=function(){var t=a.width,e=a.height;$maskCanvas.width(t),$maskCanvas.height(e),$maskCanvas.prop("width",t),$maskCanvas.prop("height",e),maskContext.drawImage(a,0,0),config.dsm.maskImage=a,hakoniwa.init()}});var mapUtil=function(){function t(){var t=[{lat:n.south,lng:n.east},{lat:n.north,lng:n.east},{lat:n.north,lng:n.west},{lat:n.south,lng:n.west}];new google.maps.Polygon({map:map,paths:t,strokeColor:"#666666",strokeOpacity:1,strokeWeight:2,fillColor:"#ffcccc",fillOpacity:.2,draggable:!1,geodesic:!0}),o=new google.maps.Polygon({map:map,paths:e(),strokeColor:"#ff0000",strokeOpacity:1,strokeWeight:2,fillColor:"#ff0000",fillOpacity:.3,draggable:!0,geodesic:!0}),o.addListener("dragend",function(){var t=o.getPath().getAt(0);i.north=t.lat(),i.west=t.lng(),console.log(i),hakoniwa.update()})}function e(){var t=n.pixelSize*i.width,e=n.pixelSize*i.height,a=i.north,o=i.west,r=[{lat:a,lng:o},{lat:a,lng:o+t},{lat:a-e,lng:o+t},{lat:a-e,lng:o}];return r}function a(){map.setCenter({lat:i.north,lng:i.west}),o.setPath(e())}var o,n=config.dsm,i=config.work;return{addPolygons:t,updateWorkAreaPosition:a}}(),hakoniwa=function(){function t(){return!(!m.image||!m.maskImage||"undefined"==typeof google)}function e(){return(f.west-m.west)/m.pixelSize}function a(){return(m.north-f.north)/m.pixelSize}function o(t,e){var a=[10025880,10145074,3329330,14596231,14329120,13468991,13789470,10506797,9127187,8388608],o=20,n=10;if(0!==e)return 3711451;for(var i=0;i<a.length;i++)if(i*n+o>t)return a[i];return 8388608}function n(){var t=dsmContext.getImageData(e(),a(),f.width,f.height);if(workContext.fillStyle="#000",workContext.fillRect(0,0,f.width,f.height),workContext.putImageData(t,0,0),m.maskImage){var o=maskContext.getImageData(e(),a(),f.width,f.height);workMaskContext.fillStyle="#000",workMaskContext.fillRect(0,0,f.width,f.height),workMaskContext.putImageData(o,0,0)}}function i(){var t,e;for(x=[],e=0;e<f.height;e++)for(x.push([]),t=0;t<f.width;t++){var a=new THREE.BoxGeometry(u,u,u),o=new THREE.MeshStandardMaterial,n=new THREE.Mesh(a,o);n.matrixAutoUpdate=!1,n.rotationAutoUpdate=!1,n.position.x=(t-f.width/2)*u,n.position.z=(e-f.height/2)*u,p.add(n),x[e].push(n)}}function r(){var t,e,a=workContext.getImageData(0,0,f.width,f.height),n=workMaskContext.getImageData(0,0,f.width,f.height);for(e=0;e<f.height;e++)for(t=0;t<f.width;t++){var i=a.data[4*t+e*f.width*4],r=n.data[4*t+e*f.width*4],s=x[e][t];s.material.color.setHex(o(i,r)),s.scale.y=i/3*(.1*k.elevationScale),s.position.y=i/2*(.1*k.elevationScale),s.updateMatrix()}}function s(){return!($stage.width()>320)}function h(){n(),r(),mapUtil.updateWorkAreaPosition()}function d(){if(t()){mapUtil.addPolygons(),n(),p=new THREE.Scene,p.autoUpdate=!1,p.fog=new THREE.Fog(16777215,80,400),camera=new THREE.PerspectiveCamera(45,$stage.width()/$stage.height(),1,1e3),camera.position.set(C/1.7,C/1.4,C),camera.lookAt(p.position),renderer=new THREE.WebGLRenderer,renderer.setSize($stage.width(),$stage.height()),$stage.append(renderer.domElement),c=new THREE.TrackballControls(camera,$stage.get(0)),c.staticMoving=!0,c.dynamicDampingFactor=1;var e=new THREE.DirectionalLight(16777215);e.position.set(0,100,20),e.castShadow=!0,p.add(e);var a;if(s()?(a=new THREE.AmbientLight(16777215),p.add(a)):(a=new THREE.AmbientLight(10066329),p.add(a)),!s()){var o=new THREE.SphereGeometry(.5,16,8);v.push(new THREE.PointLight(16744448,3,150)),v[0].position.set($,20,$),v[0].add(new THREE.Mesh(o,new THREE.MeshBasicMaterial({color:16744448}))),p.add(v[0]),v.push(new THREE.PointLight(16777088,2,150)),v[1].position.set($,20,$),v[1].add(new THREE.Mesh(o,new THREE.MeshBasicMaterial({color:16777088}))),p.add(v[1])}var h=new THREE.AxisHelper(120);p.add(h);var d=new THREE.GridHelper(100,5);p.add(d);var g=new THREE.DirectionalLightHelper(e);p.add(g),i(),r(),l()}}function g(){k.autoPilotEnabled&&(S.up?(f.north+=m.pixelSize*k.autoPilotSpeed,f.north>=m.north&&(S.reachedTop=!0),(f.north>=m.north||f.north>=S.turned.north+m.pixelSize*f.height)&&(S.up=!1,f.north-=m.pixelSize*k.autoPilotSpeed,S.prevLeft?(S.right=!0,S.prevLeft=!1):(S.left=!0,S.prevLeft=!0))):S.down?(f.north-=m.pixelSize*k.autoPilotSpeed,f.north-m.pixelSize*f.height<=m.south&&(S.down=!1,f.north+=m.pixelSize*k.autoPilotSpeed,S.prevLeft?(S.right=!0,S.prevLeft=!1):(S.left=!0,S.prevLeft=!0))):S.right?(f.west+=m.pixelSize*k.autoPilotSpeed,f.west+m.pixelSize*f.width>=m.east&&(S.right=!1,f.west-=m.pixelSize*k.autoPilotSpeed,S.reachedTop?(S.down=!0,S.reachedTop=!1):S.up=!0,S.turned.north=f.north,S.turned.west=f.west)):S.left&&(f.west-=m.pixelSize*k.autoPilotSpeed,f.west<=m.west&&(S.left=!1,f.west+=m.pixelSize*k.autoPilotSpeed,S.reachedTop?(S.down=!0,S.reachedTop=!1):S.up=!0,S.turned.north=f.north,S.turned.west=f.west)))}function w(){v.length>=2&&(E+=.1,v[0].position.x=$*Math.sin(E),v[0].position.y=$/2*(Math.sin(.3*E)+1),v[0].position.z=$*Math.cos(.8*E),v[1].position.x=$*Math.sin(.9*-E),v[1].position.y=$/2*(Math.sin(.2*-E)+1),v[1].position.z=$*Math.cos(-E)),k.autoPilotEnabled&&(g(),h()),c.update(),p.updateMatrixWorld(),renderer.render(p,camera)}function l(){requestAnimationFrame(l),w()}var p,c,m=config.dsm,u=config.cube.size,f=config.work,k=config.gui,v=[],$=70,C=145,E=-1,x=[],S={up:!1,down:!1,right:!0,left:!1,turned:{north:0,west:0},reachedTop:!1,prevLeft:!1},M=new dat.GUI;return M.add(k,"autoPilotEnabled"),M.add(k,"autoPilotSpeed",.5,30),M.add(k,"elevationScale",1,10),$datGui.append(M.domElement),{init:d,update:h}}();</script><script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCsCy6ieDrZgPDMgZjUTK2WqAyBGn3SdII&callback=initMap" async defer="defer"></script><script src="/assets/js/analytics.js"></script></body></html>