<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@knt5"><meta name="twitter:creator" content="@knt5"><meta name="twitter:title" content="Kenta Motomura"><meta name="twitter:description" content="Hakoniwa - JAXA ALOS DSM 3D visualizer"><title>Hakoniwa</title><style>html,body,div,span,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,abbr,address,cite,code,del,dfn,em,img,ins,kbd,q,samp,small,strong,sub,sup,var,b,i,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,figcaption,figure,footer,header,hgroup,menu,nav,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}ol,ul{padding-left:20px}article,aside,details,figcaption,figure,footer,header,hgroup,menu,nav,section{display:block}nav ul{list-style:none}blockquote,q{quotes:none}blockquote::before,blockquote::after,q::before,q::after{content:none}a{margin:0;padding:0;font-size:100%;vertical-align:baseline;background:transparent}ins{background-color:#ff9;color:#000;text-decoration:none}mark{background-color:#ff9;color:#000;font-style:italic;font-weight:bold}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}hr{display:block;height:1px;border:0;border-top:1px solid #ccc;margin:1em 0;padding:0}input,select{vertical-align:middle}*,*::before,*::after{box-sizing:border-box}body{background:#000;color:#fff;font-size:18px;line-height:1.4;-webkit-text-size-adjust:100%}body,input,select,textarea,th,td{font-family:"Myriad Pro", "Lucida Grande", "GillSans", "Hiragino Kaku Gothic Pro", "Meiryo", "sans-serif"}a{color:#39f}a:link,a:visited,a:active{text-decoration:none}a:hover{text-decoration:underline}.clearfix::after{content:'';display:block;clear:both}.hidden{display:none}.main{position:relative;background:#000}.stage{position:relative;background-image:linear-gradient(to top, #434343, #000)}.header{position:absolute;top:0;left:0;padding:10px 15px;z-index:9000}.header h1{font-size:38px;font-weight:normal}.header p{font-size:12px}.message{margin-top:4px;font-size:14px}.error{margin-top:4px;font-size:14px;color:#f00}.map{position:absolute;width:300px;height:200px;bottom:0;right:0;z-index:9000}@media (max-width: 414px){.map{width:100%;height:120px}.github-ribbon img{width:74px;height:74px}.header h1{font-size:24px}}</style></head><body><canvas id="dsm-canvas" class="hidden"></canvas><canvas id="mask-canvas" class="hidden"></canvas><canvas id="work-canvas" class="hidden"></canvas><canvas id="work-mask-canvas" class="hidden"></canvas><div id="main" class="main"><div id="stage" class="stage"></div><header class="header"><h1>Hakoniwa</h1><p>JAXA ALOS DSM 3D visualizer Â© <a href="https://knt5.github.io/" target="_blank">knt5</a></p><div id="message" class="message"></div><div id="error" class="error"></div></header><div id="map" class="map"></div></div><div class="github-ribbon"><a href="https://github.com/knt5/hakoniwa"><img style="position: absolute; top: 0; right: 0; border: 0" src="https://camo.githubusercontent.com/52760788cde945287fbb584134c4cbc2bc36f904/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f77686974655f6666666666662e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png"></a></div><script src="assets/js/lib/jquery.min.js?v=3.0.0-beta1"></script><script src="assets/js/lib/three.min.js?v=r76"></script><script src="assets/js/lib/TrackballControls.js"></script><script src="assets/js/lib/dat.gui.min.js?v=0.5.1"></script><script>function initMap(){var e=config.dsm,t=config.work;map=new google.maps.Map($map.get(0),{center:{lat:t.north,lng:t.west},zoom:12});var a={north:e.north,south:e.south,east:e.east,west:e.west},n=new google.maps.GroundOverlay(e.path,a);n.setOpacity(.8),n.setMap(map),hakoniwa.init()}var config={dsm:{path:"assets/dsm/N035E139.tokyo.png",maskPath:"assets/dsm/N035E139.tokyo.mask.png",north:35.76,east:139.81,south:35.61,west:139.68,pixelSize:.000277777778,image:null,maskImage:null},work:{width:50,height:50,north:35.633678619189524,west:139.72721500523392},cube:{size:3}},$window=$(window),$stage=$("#stage"),$dsmCanvas=$("#dsm-canvas"),$maskCanvas=$("#mask-canvas"),$workCanvas=$("#work-canvas"),$workMaskCanvas=$("#work-mask-canvas"),$map=$("#map"),$message=$("#message"),$error=$("#error"),map,camera,renderer,dsmContext=$dsmCanvas.get(0).getContext("2d"),maskContext=$maskCanvas.get(0).getContext("2d"),workContext=$workCanvas.get(0).getContext("2d"),workMaskContext=$workMaskCanvas.get(0).getContext("2d");$(document).ready(function(){function e(){$stage.height($window.height()),camera&&renderer&&(camera.aspect=$stage.width()/$stage.height(),camera.updateProjectionMatrix(),renderer.setSize($stage.width(),$stage.height()))}$window.on("resize",e),e(),$workCanvas.width(config.work.width),$workCanvas.height(config.work.height),$workCanvas.prop("width",config.work.width),$workCanvas.prop("height",config.work.height),$workMaskCanvas.width(config.work.width),$workMaskCanvas.height(config.work.height),$workMaskCanvas.prop("width",config.work.width),$workMaskCanvas.prop("height",config.work.height);var t=new Image;t.src=config.dsm.path,t.onload=function(){var e=t.width,a=t.height;$dsmCanvas.width(e),$dsmCanvas.height(a),$dsmCanvas.prop("width",e),$dsmCanvas.prop("height",a),dsmContext.drawImage(t,0,0),config.dsm.image=t,hakoniwa.init()};var a=new Image;a.src=config.dsm.maskPath,a.onload=function(){var e=a.width,t=a.height;$maskCanvas.width(e),$maskCanvas.height(t),$maskCanvas.prop("width",e),$maskCanvas.prop("height",t),maskContext.drawImage(a,0,0),config.dsm.maskImage=a,hakoniwa.init()}});var mapUtil=function(){function e(){var e=[{lat:o.south,lng:o.east},{lat:o.north,lng:o.east},{lat:o.north,lng:o.west},{lat:o.south,lng:o.west}];new google.maps.Polygon({map:map,paths:e,strokeColor:"#666666",strokeOpacity:1,strokeWeight:2,fillColor:"#ffcccc",fillOpacity:.2,draggable:!1,geodesic:!0}),n=new google.maps.Polygon({map:map,paths:t(),strokeColor:"#ff0000",strokeOpacity:1,strokeWeight:2,fillColor:"#ff0000",fillOpacity:.3,draggable:!0,geodesic:!0}),n.addListener("dragend",function(){var e=n.getPath().getAt(0);i.north=e.lat(),i.west=e.lng(),console.log(i),hakoniwa.update()})}function t(){var e=o.pixelSize*i.width,t=o.pixelSize*i.height,a=i.north,n=i.west,r=[{lat:a,lng:n},{lat:a,lng:n+e},{lat:a-t,lng:n+e},{lat:a-t,lng:n}];return r}function a(){map.setCenter({lat:i.north,lng:i.west}),n.setPath(t())}var n,o=config.dsm,i=config.work;return{addPolygons:e,updateWorkAreaPosition:a}}(),hakoniwa=function(){function e(){return!(!m.image||!m.maskImage||"undefined"==typeof google)}function t(){return(k.west-m.west)/m.pixelSize}function a(){return(m.north-k.north)/m.pixelSize}function n(e,t){var a=[10025880,10145074,3329330,14596231,14329120,13468991,13789470,10506797,9127187,8388608],n=20,o=10;if(0!==t)return 3711451;for(var i=0;i<a.length;i++)if(i*o+n>e)return a[i];return 8388608}function o(){var e=dsmContext.getImageData(t(),a(),k.width,k.height);if(workContext.fillStyle="#000",workContext.fillRect(0,0,k.width,k.height),workContext.putImageData(e,0,0),m.maskImage){var n=maskContext.getImageData(t(),a(),k.width,k.height);workMaskContext.fillStyle="#000",workMaskContext.fillRect(0,0,k.width,k.height),workMaskContext.putImageData(n,0,0)}}function i(){var e,t;for(x=[],t=0;t<k.height;t++)for(x.push([]),e=0;e<k.width;e++){var a=new THREE.BoxGeometry(f,f,f),n=new THREE.MeshStandardMaterial,o=new THREE.Mesh(a,n);o.matrixAutoUpdate=!1,o.rotationAutoUpdate=!1,o.position.x=(e-k.width/2)*f,o.position.z=(t-k.height/2)*f,l.add(o),x[t].push(o)}}function r(){var e,t,a=workContext.getImageData(0,0,k.width,k.height),o=workMaskContext.getImageData(0,0,k.width,k.height);for(t=0;t<k.height;t++)for(e=0;e<k.width;e++){var i=a.data[4*e+t*k.width*4],r=o.data[4*e+t*k.width*4],s=x[t][e];s.material.color.setHex(n(i,r)),s.scale.y=i/3*(.1*M),s.position.y=i/2*(.1*M),s.updateMatrix()}}function s(){return!($stage.width()>320)}function h(){o(),r(),mapUtil.updateWorkAreaPosition()}function d(){if(e()){mapUtil.addPolygons(),o(),l=new THREE.Scene,l.autoUpdate=!1,l.fog=new THREE.Fog(16777215,80,400),camera=new THREE.PerspectiveCamera(45,$stage.width()/$stage.height(),1,1e3),camera.position.set($/1.3,$/1.4,$),camera.lookAt(l.position),renderer=new THREE.WebGLRenderer,renderer.setSize($stage.width(),$stage.height()),$stage.append(renderer.domElement),c=new THREE.TrackballControls(camera,$stage.get(0)),c.staticMoving=!0,c.dynamicDampingFactor=1;var t=new THREE.DirectionalLight(16777215);t.position.set(0,100,20),t.castShadow=!0,l.add(t);var a;if(s()?(a=new THREE.AmbientLight(16777215),l.add(a)):(a=new THREE.AmbientLight(10066329),l.add(a)),!s()){var n=new THREE.SphereGeometry(.5,16,8);u.push(new THREE.PointLight(16744448,3,150)),u[0].position.set(v,20,v),u[0].add(new THREE.Mesh(n,new THREE.MeshBasicMaterial({color:16744448}))),l.add(u[0]),u.push(new THREE.PointLight(16777088,2,150)),u[1].position.set(v,20,v),u[1].add(new THREE.Mesh(n,new THREE.MeshBasicMaterial({color:16777088}))),l.add(u[1])}var h=new THREE.AxisHelper(120);l.add(h);var d=new THREE.GridHelper(100,5);l.add(d);var g=new THREE.DirectionalLightHelper(t);l.add(g),i(),r(),p()}}function g(){E.enabled&&(E.up?(k.north+=m.pixelSize*E.speed,k.north>=m.north&&(E.reachedTop=!0),(k.north>=m.north||k.north>=E.turned.north+m.pixelSize*k.height)&&(E.up=!1,k.north-=m.pixelSize*E.speed,E.prevLeft?(E.right=!0,E.prevLeft=!1):(E.left=!0,E.prevLeft=!0))):E.down?(k.north-=m.pixelSize*E.speed,k.north-m.pixelSize*k.height<=m.south&&(E.down=!1,k.north+=m.pixelSize*E.speed,E.prevLeft?(E.right=!0,E.prevLeft=!1):(E.left=!0,E.prevLeft=!0))):E.right?(k.west+=m.pixelSize*E.speed,k.west+m.pixelSize*k.width>=m.east&&(E.right=!1,k.west-=m.pixelSize*E.speed,E.reachedTop?(E.down=!0,E.reachedTop=!1):E.up=!0,E.turned.north=k.north,E.turned.west=k.west)):E.left&&(k.west-=m.pixelSize*E.speed,k.west<=m.west&&(E.left=!1,k.west+=m.pixelSize*E.speed,E.reachedTop?(E.down=!0,E.reachedTop=!1):E.up=!0,E.turned.north=k.north,E.turned.west=k.west)))}function w(){u.length>=2&&(C+=.1,u[0].position.x=v*Math.sin(C),u[0].position.y=v/2*(Math.sin(.3*C)+1),u[0].position.z=v*Math.cos(.8*C),u[1].position.x=v*Math.sin(.9*-C),u[1].position.y=v/2*(Math.sin(.2*-C)+1),u[1].position.z=v*Math.cos(-C)),g(),h(),c.update(),l.updateMatrixWorld(),renderer.render(l,camera)}function p(){requestAnimationFrame(p),w()}var l,c,m=config.dsm,f=config.cube.size,k=config.work,u=[],v=70,$=130,C=-1,x=[],E={enabled:!0,up:!1,down:!1,right:!0,left:!1,turned:{north:0,west:0},reachedTop:!1,prevLeft:!1,speed:1},M=4;return{init:d,update:h}}();</script><script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCsCy6ieDrZgPDMgZjUTK2WqAyBGn3SdII&callback=initMap" async defer="defer"></script><script src="/assets/js/analytics.js"></script></body></html>